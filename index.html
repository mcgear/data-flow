<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <meta name="description" content="IoT projects to get you going in minutes, not weeks or months." />

  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="stylesheet" href="./static/css/app.css" />
  <script src="https://kit.fontawesome.com/0b7385f8de.js" crossorigin="anonymous"></script>

  <script type="module" src="./packages/es/index.js"></script>

 
</head>

<body>

  <div class="base gap" style="margin-top: 30px; width: 100%; height: 75px;">
    <div class="request">Request</div>
    <div class="project">Project</div>
    <div class="route-filter">Route Filter</div>
    <div class="application">Application</div>
    <div class="modifier">DFS Modifier</div>
    <div class="join">Join</div>
    <div class="split">Split</div>
    <div class="decision">Decision</div>
    <div class="event">Event</div>
  </div>

  <header>
    <h2>Data Flow Tool</h2>
  </header>

  <div class="wrapper">
    <!-- 
              Left side menu items
           -->
    <div id="drag-items" class="col"></div>

    <div class="col-right">
      <div class="top-menu">
        <ul>
          <li onclick="flowTool.ChangeModule('Home'); 
                    menuTabSelected(event);" class="selected">
            Home
          </li>
          <li onclick="flowTool.ChangeModule('Other'); 
                    menuTabSelected(event);">
            Other Module
          </li>
        </ul>
      </div>

      <!-- Flow Tool -->
      <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
      </div>
    </div>
  </div>
  </div>

  <script id="sjs-flow-tool" type="module">

    import {
      FlowTool,
      MenuTemplates,
      Variables,
      Events,
      ConstantUtils,
      NodeTemplates,
      DragItemsTemplates,
      PositionUtils
    } from './packages/es/index.js';

    let canvas = document.getElementById("drawflow");	
    let flowTool = new FlowTool(canvas, canvas);

    /**
     * Create side menu of draggable items
     * 
     * This calls MENU_TEMPLATES, but can be any external source
    */
    MenuTemplates.Render(document.getElementById('drag-items'), DragItemsTemplates.MENU_TEMPLATES(drag));

    // Variables.reroute = true;
    // Variables.reroute_fix_curvature = true;
    // Variables.force_first_input = false;

    /**
     * Array for storing module data
    */
    Variables.DataFlowModuleData =
    [
      ConstantUtils.HOME_MODULE_DATA,
      ConstantUtils.OTHER_MODULE_DATA
    ]

    flowTool.Init(Variables.DataFlowModuleData[0]);

    /* DRAG EVENT */

    /* Mouse and Touch Actions */

    const elements = document.getElementsByClassName('drag-drawflow');

    for (var i = 0; i < elements.length; i++) {
      elements[i].addEventListener('touchend', drop, false);
      elements[i].addEventListener('touchmove', positionMobile, false);
      elements[i].addEventListener('touchstart', drag, false);
    }

    let mobile_item_selec = '';
    let mobile_last_move = null;

    function positionMobile(ev) {
      mobile_last_move = ev;
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    /**
     * When dragging an item from the side menu onto the canvas 
     **/
    function drag(ev) {
      if (ev.type === "touchstart") {
        mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
      } else {
        ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
      }
    }

    function drop(ev) {
      if (ev.type === "touchend") {
        var parentdrawflow = document.elementFromPoint(mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
        if (parentdrawflow != null) {
          addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
        }
        mobile_item_selec = '';
      } else {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("node");
        addNodeToDrawFlow(data, ev.clientX, ev.clientY);
      }

    }

    function addNodeToDrawFlow(name, x, y) {

      if (Variables.editor_mode === 'fixed') {
        return false;
      }
      
      let posX = PositionUtils.DraggedNodeXPos(x);	
      let posY = PositionUtils.DraggedNodeYPos(y);

      switch (name) {
        case 'request':
          flowTool.AddNode
          (
            {
              Name: 'request', 
              NumOfInputs: 0, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['request'], 
              Data: {}, 
              HTML: NodeTemplates.Request,
              TypeNode: false
            }
          );
          break;
        case 'facebook':
          flowTool.AddNode
          (
            {
              Name: 'facebook', 
              NumOfInputs: 0, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['facebook'], 
              Data: {}, 
              HTML: NodeTemplates.Facebook,
              TypeNode: false
            }
          );
          break;
        case 'slack':
          flowTool.AddNode
          (
            {
              Name: 'slack', 
              NumOfInputs: 1, 
              NumOfOutputs: 0, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['slack'], 
              Data: {}, 
              HTML: NodeTemplates.Slack,
              TypeNode: false
            }  
          );
          break;
        case 'github':
          flowTool.AddNode
          (
            {
              Name: 'github', 
              NumOfInputs: 0, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['github'], 
              Data: {}, 
              HTML: NodeTemplates.Github,
              TypeNode: false
            }
          );
          break;
        case 'telegram':
          flowTool.AddNode
          (
            {
              Name: 'telegram', 
              NumOfInputs: 0, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['telegram'], 
              Data: {}, 
              HTML: NodeTemplates.Telegram,
              TypeNode: false
            }
          );
          break;
        case 'aws':
          flowTool.AddNode
          (
            {
              Name: 'aws', 
              NumOfInputs: 0, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['aws'], 
              Data: {}, 
              HTML: NodeTemplates.AWS,
              TypeNode: false
            }
          );
          break;
        case 'log':
          flowTool.AddNode
          (
            {
              Name: 'log', 
              NumOfInputs: 1, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['log'], 
              Data: {}, 
              HTML: NodeTemplates.Log,
              TypeNode: false
            }
          );
          break;
        case 'google':
          flowTool.AddNode
          (
            {
              Name: 'google', 
              NumOfInputs: 1, 
              NumOfOutputs: 0, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['google'], 
              Data: {}, 
              HTML: NodeTemplates.Google,
              TypeNode: false
            }
          );
          break;
        case 'email':
          flowTool.AddNode
          (
            {
              Name: 'email', 
              NumOfInputs: 1, 
              NumOfOutputs: 0, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['email'], 
              Data: {}, 
              HTML: NodeTemplates.Email,
              TypeNode: false
            }
          );
          break;
        case 'template':
          flowTool.AddNode
          (
            {
              Name: 'template', 
              NumOfInputs: 1, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['template'], 
              Data: {}, 
              HTML: NodeTemplates.Template,
              TypeNode: false
            }
          );
          break;
        case 'multiple':
          flowTool.AddNode
          (
            {
              Name: 'multiple', 
              NumOfInputs: 3, 
              NumOfOutputs: 4, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['multiple'], 
              Data: {}, 
              HTML: NodeTemplates.Multiple,
              TypeNode: false
            }
          );
          break;
        case 'personalized':
          flowTool.AddNode
          (
            {
              Name: 'personalized', 
              NumOfInputs: 1, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['personalized'], 
              Data: {}, 
              HTML: NodeTemplates.Personalized,
              TypeNode: false
            }
          );
          break;
        case 'dbclick':
          flowTool.AddNode
          (
            {
              Name: 'dbclick', 
              NumOfInputs: 0, 
              NumOfOutputs: 1, 
              PosX: posX, 
              PosY: posY, 
              ClassList: ['dbclick'], 
              Data: {}, 
              HTML: NodeTemplates.DBLClick,
              TypeNode: false
            }
          );
          break;

        default:
      }
    }

    var transform = '';

    function showPopup(e) {
      console.log('showPopup');
      e.target.closest(".drawflow-node").style.zIndex = "9999";
      e.target.children[0].style.display = "block";
      //document.getElementById("modalfix").style.display = "block";

      //e.target.children[0].style.transform = 'translate('+translate.x+'px, '+translate.y+'px)';
      transform = Variables.PreCanvas.style.transform;
      Variables.PreCanvas.style.transform = '';
      Variables.PreCanvas.style.left = Variables.CanvasX + 'px';
      Variables.PreCanvas.style.top = Variables.CanvasY + 'px';
      console.log(transform);

      //e.target.children[0].style.top  =  -flowTool.canvas_y - flowTool.container.offsetTop +'px';
      //e.target.children[0].style.left  =  -flowTool.canvas_x  - flowTool.container.offsetLeft +'px';
      Variables.EditorMode = "fixed";

    }

    function closeModal(e) {
      e.target.closest(".drawflow-node").style.zIndex = "2";
      e.target.parentElement.parentElement.style.display = "none";
      //document.getElementById("modalfix").style.display = "none";
      Variables.PreCanvas.style.transform = transform;
      Variables.PreCanvas.style.left = '0px';
      Variables.PreCanvas.style.top = '0px';
      Variables.EditorMode = "edit";
    }

    /**
     * Add / remove styles on menu tab click
     **/
    function menuTabSelected(event) {
      var all = document.querySelectorAll(".top-menu ul li");
      for (var i = 0; i < all.length; i++) {
        all[i].classList.remove('selected');
      }
      event.target.classList.add('selected');
    }

    function changeMode(option) {

      //console.log(lock.id);
      if (option == 'lock') {
        lock.style.display = 'none';
        unlock.style.display = 'block';
      } else {
        lock.style.display = 'block';
        unlock.style.display = 'none';
      }
    }

    /**
     * Need to create global properties, so we 
     * have access to variables from within
     * 
     * We don't want to do this, but this works for now - shannon
     **/
    window.allowDrop = allowDrop;
    window.drop = drop;
    window.flowTool = flowTool;
    window.menuTabSelected = menuTabSelected;
    window.showPopup = showPopup;
    window.closepopup = closeModal;
  </script>
</body>

</html>